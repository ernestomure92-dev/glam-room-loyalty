<script src="js/firebase-config.js"></script>
<script>
  // Script inline simple para mis-citas
  document.addEventListener('DOMContentLoaded', async function() {
    const userData = JSON.parse(sessionStorage.getItem('glamUser'));
    const contenedor = document.getElementById('lista-citas');
    
    if (!userData) {
      contenedor.innerHTML = '<p class="error-text">Debes iniciar sesi√≥n primero</p>';
      setTimeout(() => window.location.href = 'index.html', 2000);
      return;
    }
    
    try {
      // Consulta simple sin ordenamiento complejo
      const snapshot = await db.collection('appointments').get();
      
      // Filtrar en el cliente
      const misCitas = [];
      snapshot.forEach(doc => {
        const cita = doc.data();
        if (cita.userId === userData.id && cita.estado !== 'cancelada') {
          misCitas.push({ id: doc.id, ...cita });
        }
      });
      
      // Ordenar manualmente
      misCitas.sort((a, b) => {
        if (a.fecha !== b.fecha) return a.fecha.localeCompare(b.fecha);
        return a.hora.localeCompare(b.hora);
      });
      
      if (misCitas.length === 0) {
        contenedor.innerHTML = `
          <div class="empty-state">
            <p>No tienes citas agendadas</p>
            <a href="agendar.html" class="btn-primary" style="display: inline-block; margin-top: 20px;">Agendar mi primera cita</a>
          </div>
        `;
        return;
      }
      
      const hoy = new Date().toISOString().split('T')[0];
      let html = '';
      
      misCitas.forEach(cita => {
        const esPasada = cita.fecha < hoy;
        const clase = esPasada ? 'cita-pasada' : 'cita-proxima';
        
        html += `
          <div class="cita-card ${clase}">
            <div class="cita-header">
              <span class="cita-servicio">${cita.servicio}</span>
              <span class="cita-estado ${cita.estado}">${cita.estado}</span>
            </div>
            <div class="cita-fecha">
              üìÖ ${formatearFecha(cita.fecha)} | üïê ${cita.hora}
            </div>
            <div class="cita-duracion">‚è±Ô∏è ${cita.duracion} minutos</div>
            ${!esPasada && cita.estado === 'confirmada' ? `
              <button onclick="cancelarCita('${cita.id}')" class="btn-cancelar">
                Cancelar Cita
              </button>
            ` : ''}
          </div>
        `;
      });
      
      contenedor.innerHTML = html;
      
    } catch (error) {
      console.error('Error:', error);
      contenedor.innerHTML = '<p class="error-text">Error al cargar citas: ' + error.message + '</p>';
    }
  });
  
  function formatearFecha(fecha) {
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(fecha).toLocaleDateString('es-MX', opciones);
  }
  
  async function cancelarCita(citaId) {
    if (!confirm('¬øCancelar esta cita?')) return;
    
    try {
      await db.collection('appointments').doc(citaId).update({
        estado: 'cancelada',
        cancelada: firebase.firestore.FieldValue.serverTimestamp()
      });
      Toast.show('Cita cancelada', 'success');
      setTimeout(() => location.reload(), 1000);
    } catch (error) {
      Toast.show('Error al cancelar', 'error');
    }
  }
  
  window.cancelarCita = cancelarCita;
</script>
